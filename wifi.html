<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Wifi Configuration - StairLeds</title>

    <link rel="stylesheet" href="css/fontawesome5.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dark.css">
</head>

<body id="page-top">
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-walking"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>StairLeds</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="nav navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item" role="presentation"><a class="nav-link" href="index.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a><a class="nav-link" href="about.html"><i class="fas fa-sliders-h"></i><span>Manual Control</span></a><a class="nav-link" href="about.html"><i class="fas fa-chess-knight"></i><span>Demo's</span></a></li>
                    <li
                        class="nav-item" role="presentation"></li>
                        <li class="nav-item" role="presentation">
                            <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                                <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-cogs"></i></div>
                                <div class="sidebar-brand-text mx-3"><span>Settings</span></div>
                            </a><a class="nav-link active" href="wifi.html"><i class="fas fa-wifi"></i><span>Wifi&nbsp;</span></a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" href="pca9685.html"><i class="fas fa-microchip"></i><span>PCA9685 Pin mappings</span></a><a class="nav-link" href="pir.html"><i class="fas fa-wifi" style="transform: rotateZ(90deg);"></i><span>PIR Sensors</span></a>
                            <a
                                class="nav-link" href="leds.html"><i class="far fa-lightbulb"></i><span>LED Effects</span></a><a class="nav-link" href="ntp.html"><i class="far fa-clock"></i><span>NTP &amp; Off Times</span></a><a class="nav-link" href="mqtt.html"><i class="fas fa-microchip"></i><span>MQTT</span></a></li>
                        <li
                            class="nav-item" role="presentation"></li>
                            <li class="nav-item" role="presentation"><a class="nav-link" href="about.html"><i class="fas fa-info-circle"></i><span>About</span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper" style="background-color: #212121;">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-dark shadow mb-4 topbar static-top">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button>
                        <form class="form-inline d-none d-sm-inline-block mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                            <div class="input-group">
                                <div class="input-group-append"></div>
                            </div>
                        </form>
                        <ul class="nav navbar-nav flex-nowrap ml-auto">
                            <li class="nav-item dropdown d-sm-none no-arrow"><a class="dropdown-toggle nav-link" data-toggle="dropdown" aria-expanded="false" href="#"><i class="fas fa-search"></i></a>
                                <div class="dropdown-menu dropdown-menu-right p-3 animated--grow-in" role="menu" aria-labelledby="searchDropdown">
                                    <form class="form-inline mr-auto navbar-search w-100">
                                        <div class="input-group"><input class="bg-light form-control border-0 small" type="text" placeholder="Search for ...">
                                            <div class="input-group-append"><button class="btn btn-primary py-0" type="button"><i class="fas fa-search"></i></button></div>
                                        </div>
                                    </form>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1" role="presentation"></li>
                            <li class="nav-item dropdown no-arrow mx-1" role="presentation">
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-right" aria-labelledby="alertsDropdown"></div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow" role="presentation">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" data-toggle="dropdown" aria-expanded="false" href="#">Current time: 19:56</a>
                                    <div class="dropdown-menu shadow dropdown-menu-right animated--grow-in" role="menu"><a class="dropdown-item" role="presentation" href="#"><i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>&nbsp;Profile</a><a class="dropdown-item" role="presentation" href="#"><i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>&nbsp;Settings</a>
                                        <a
                                            class="dropdown-item" role="presentation" href="#"><i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>&nbsp;Activity log</a>
                                            <div class="dropdown-divider"></div><a class="dropdown-item" role="presentation" href="#"><i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>&nbsp;Logout</a></div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid" style="background-color: #212121;">
                    <h3 class="text-dark mb-4">Wifi Settings</h3>
                    <div class="row mb-3">
                        <div class="col-lg-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="text-primary font-weight-bold m-0">Nearby Access Points</h6>
                                    
                                </div>
                                <div class="card-body" id="networks">
                                        <i class="fa fa-spin fa-4x"></i>
                                 </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="row mb-3 d-none">
                                <div class="col">
                                    <div class="card text-white bg-primary shadow">
                                        <div class="card-body">
                                            <div class="row mb-2">
                                                <div class="col">
                                                    <p class="m-0">Peformance</p>
                                                    <p class="m-0"><strong>65.2%</strong></p>
                                                </div>
                                                <div class="col-auto"><i class="fas fa-rocket fa-2x"></i></div>
                                            </div>
                                            <p class="text-white-50 small m-0"><i class="fas fa-arrow-up"></i>&nbsp;5% since last month</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="card text-white bg-success shadow">
                                        <div class="card-body">
                                            <div class="row mb-2">
                                                <div class="col">
                                                    <p class="m-0">Peformance</p>
                                                    <p class="m-0"><strong>65.2%</strong></p>
                                                </div>
                                                <div class="col-auto"><i class="fas fa-rocket fa-2x"></i></div>
                                            </div>
                                            <p class="text-white-50 small m-0"><i class="fas fa-arrow-up"></i>&nbsp;5% since last month</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="card shadow mb-3">
                                        <div class="card-header py-3">
                                            <p class="text-primary m-0 font-weight-bold">Access Point Settings</p>
                                        </div>
                                        <div class="card-body">
                                            <form>
                                                <div class="form-row">
                                                    <div class="col">
                                                        <div class="form-group"><label for="username"><strong>AP Name</strong></label><input class="form-control" type="text" placeholder="select an access point" name="apname"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-group"><label for="email"><strong>Password</strong></label><input class="form-control" type="email" placeholder="******" name="email"></div>
                                                    </div>
                                                </div>
                                                <div class="form-group"><button class="btn btn-primary btn-sm" type="submit">Save Settings</button></div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="card shadow">
                                        <div class="card-header py-3">
                                            <p class="text-primary m-0 font-weight-bold">Additional Settings</p>
                                        </div>
                                        <div class="card-body">
                                            <form>
                                                <div class="form-group"><label for="address"><strong>Hostname</strong></label><input class="form-control" type="text" placeholder="stairleds" name="hostname"></div>
                                                <div class="form-group"><button class="btn btn-primary btn-sm" type="submit">Save&nbsp;Settings</button></div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer" style="background-color: transparent !important;">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © SchizoDuckie 2020</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a></div>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bs-init.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/mustache.min.js"></script>

    <script>
            jQuery(document).ready(function($){
 
                
                $("#networks").on("mousedown touchstart", 'li', function() {
                  currentNetwork = this.dataset.name;
                  
                  $("#networks .selected").removeClass('selected');
                  $(this).addClass('selected');
                });
                
                $("button").on("mousedown touchstart", function() {
                  $("input[name=password]").blur();
    
                  var password = $("input[name=password]").val();
                  
                  $("div.item").hide();
                  $("div.restart").show();

                  $.ajax({
                      url: "/config?ssid=" + currentNetwork + "&password=" + password,
                  }).done(function() {
                    $.ajax({
                        url: "/reset",
                    }).done(function() {
                      window.setInterval(function() {
                        $.ajax({
                            url: "/ping",
                        }).done(function(r) {
                          if (r == "pong") {
                            window.location = "index.htm";
                          }
                        });
                      }, 3 * 1000);
                    });
                  });
                });
            });


            class WifiScanner {

                constructor() {
                    this.networks = {}
                    this.scan();
                }

                scan() {
                    $.ajax({
                      url: "/scan",
                    }).done(this.update.bind(this));
                }

                update(networks) {
                    this.parseList(networks);
                    this.render(this.networks);
                    setTimeout(this.scan.bind(this), 5 * 1000);
                }

                parseList(networks) {
                   networks.map((network) => {
                     let rssi = network.rssi;
                     let signalClass = "danger";
                     if (rssi > -70) {
                        signalClass = "success";
                      } else if (rssi > -80) {
                        signalClass = "info";
                      } else if (rssi > -90) {
                        signalClass = "warning";
                      }
                      network.signalClass = signalClass;
                      network.strength = 100 - (rssi * -1); 
                      this.networks[network.ssid] = network;
                   })
                }

                rssisorter(a, b) {
                    if ( a.rssi < b.rssi ) return 1;
                    if ( a.rssi > b.rssi ) return -1;
                    return 0;
                }

                render() {
                     $("#networks").html(
                        Mustache.render($("#wifi").text(), {
                            networks: Object.values(this.networks).sort(this.rssisorter)
                        })
                    );
                }
            }

            let scanner = new WifiScanner();

        

        </script>
    <script id="wifi" type="x-tmpl-mustache">
         {{#networks}}
         <h4 class="small font-weight-bold" data-name="{{ssid}}"><i class="fa fa-wifi"></i>&nbsp;{{ssid}}<span class="float-right">{{rssi}}dbm</span></h4>
            <div class="progress progress-sm mb-3">
            <div class="progress-bar bg-{{signalClass}}" aria-valuenow="{{strength}}" aria-valuemin="0" aria-valuemax="100" style="width: {{strength}}%;"><span class="sr-only">{{rssi}}dbm</span></div>
        </div>
        {{/networks}}  
    </script>

</body>

</html>